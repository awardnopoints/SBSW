{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- <link rel="icon" href="../../favicon.ico"> -->

    <title>SBSW</title>

   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <link rel="stylesheet" type="text/css" href="{% static 'dbus/index.css' %}">
      <link href="https://fonts.googleapis.com/css?family=Kirang+Haerang|Lato:400,700,700i|Montserrat:400,500,600,700,700i,800|Rubik:400,700,700i" rel="stylesheet">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.0/css/bootstrap-datepicker3.standalone.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
     <!-- moment.js must be loaded first -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.js"></script>

<!-- bootstrap-datetimepicker -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
      <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
      
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
  </head>


  <body background="https://oscarsinternational.com/wp-content/uploads/2017/02/Oscars-Intenational-Dublin-Ireland.jpg" style="no-repeat">
      <div class="background"></div>
    <!-- Static navbar -->
    <nav class="navbar" style=background-color:transparent;  >
     
        <div class="navbar-header" style="float: right; margin-right: 50px;">
          <h1>SBSW</h1>
        </div>
        
         <img id = "info_icon" src = {% static 'images/info.png'%}>
	<div class = "info_modal">
		<div class="modal-content">
		<span id = "close_modal">x</span>
		<br>
		<h1>Hello and welcome to Strategic Bus Solutions Worldwide</h1>
		<div id="site-description">
		<span id = "title">Below you will find two main options:</span>
		<ul>
			<li>Journey Planner</li><br>
			<div class="functions">For this option you maybe enter your desired start and stop destinations and click go.
			Alternatively you may select "Use Current Location" to use your current location as your start point
			or select start and end point by clicking on the map itself. Once you have finished and clicked go, 
			scroll down to find a breakdown of you journey as well as the price of you journey</div>

			<li>Search By Route</li><br>
			<div class="functions">Use this option if you know the exact bus number you want to use as well as the number or general address
			of the start and end stop</div>
		</ul>
		</div>
		</div>
	</div>
          <div class="image"> <img id="icon" src="http://openweathermap.org/img/w/10d.png" ></div>
           <div class="other" id="city"><ul style="margin-top: -60px;"><li>  Dublin, Ireland </li>
         <br>    <li>     {{ weather.temp }} &#8451;
</li>
           

          </ul></div> 
       <!--/.nav-collapse -->
      </nav>      
         
      
<div class="container1">
       
      <div class="jumbotron text-center col-md-4" id='accordian'>

    <div class="panel panel-default" id="panel">
       
      <div class="panel-heading">
      <div class="btn-group btn-group-justified">
    <a class="btn btn-primary active" data-toggle="collapse"  data-target="#collapseExample" data-parent="#accordian" role="button" aria-expanded="false" aria-controls="collapseExample">
    Journey Planner
 
          </a>  
             <a class="btn btn-primary active" data-toggle="collapse"  data-target="#collapseExample1" data-parent="#accordian" role="button" aria-expanded="false" aria-controls="collapseExample">
    Route Search
  </a>   
           
      </div></div>

	     
                  <div class="collapse in" id="collapseExample" data-parent="accordian" id="addressToAddress" >
  <div class="panel-collapse collapse in"><div class="panel-body">
        <form method = "POST" class = "post-form" id="post-form1" required>{% csrf_token %}
            
              <h4>From </h4>
              <input id="start_address" type="text" name="start_address" style="margin-left: 0px;width: 220px;">
              <button type="button" id="geolocation" class = "save btn btn-default" style="margin-left: 50px; margin-top: 10px;"> Use Current Location</button> 
	  <br>
         <h4> To</h4>
          <input id="end_address" type="text" name="end_address" required style="margin-right: -24px;width: 220px;">
 <br>
	        
	       <br> <button id = "address_submit" type = "submit" class = "save btn btn-default" required style="float: right">Go</button>
    <br>
      </form>
      <div id = "text_results"></div>
      <div id = "price"></div>
    </div></div></div>
        <div class="collapse" id="collapseExample1" data-parent="accordian">
  <div class="panel-collapse collapse in"> <div class="panel-body">
        <!--  https://getbootstrap.com/docs/4.0/components/collapse/ --> 
        <form method = "POST" class = "post-form" id = "post-form">{% csrf_token %}
            <select id="routes" required>
              <option value="">Select Route</option>
            </select><br>
            
            <br>
            
            <select id="start" required>  
              <option value="">Select Start Stop</option>
            </select><br>
            
      <br>
            
            <select id="end" required>
              <option value="">Select End Stop</option>
            </select>
            <br>
            <br>
            
            
            <br>
            <button type = "submit" class = "save btn btn-default">Go</button>
            <div id="results"><p>  </p></div>
          </form>
    </div></div></div>
    <button type="button" id="leap_stores" class = "save btn btn-default" style="margin-left: 50px; margin-top: 10px;" > Show leap stores nearby</button><br>
    <input type="checkbox" id="checkbox" onclick="disappear()" checked style="margin-right: 2px;">Leave Now
        <br>
    <div id='date_input' style="margin-top: -30px;">
<input type="text" id="datepicker">
        <input type="text" id="timepicker"/>
    </div>
	<br>
	<br>
	<button type="submit" class = "save btn btn-default" id="clear_all">Clear All</button>	
      </div> 
            </div>  
      <!-- Main component for a primary marketing message or call to action -->
    <!--   -->
        
        
        <div id='map' class="jumbotron text-center col-md-8"> </div></div>
      <footer> <p></p></footer>
            <!-- /container -->

    <script src="{% static 'dbus/markerclusterer.js' %}"></script>
    <script src="{% static 'dbus/jquery-3.3.1.min.js' %}"></script>
       <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
     <script type="text/javascript" src="https://jonthornton.github.io/jquery-timepicker/jquery.timepicker.js"></script>
      <link rel="stylesheet" type="text/css" href="https://jonthornton.github.io/jquery-timepicker/jquery.timepicker.css">
      <script type="text/javascript" src="https://jonthornton.github.io/jquery-timepicker/lib/bootstrap-datepicker.js"></script>
<link rel="stylesheet" type="text/css" href="https://jonthornton.github.io/jquery-timepicker/lib/bootstrap-datepicker.css">

    <script type = "text/javascript">
         
  $(document).ready(function() {
        $("#datepicker").datepicker('option',{ minDate: "-1D", maxDate: "+4D"});
      $('#timepicker').timepicker({ 'scrollDefault': 'now', 'timeFormat': 'H:i'});
  });
 
      $('#routes').prop('disabled', true);
      $('#routes').html('<option>Loading...</option>');
      $('#end').prop('disabled', true);
      $('#start').prop('disabled', true);
      var map; 
      var markers = []
      var directionsDisplay;
      var directionsService;
      var directions;
      var placeSearch, autocomplete_start, autocomplete_end; 
      var weather_description = "{{weather.description}}";
      var current_location;
      var c = new Date();
      var f = new Date(c);
      f.setDate(f.getDate() + 4);
      console.log(c < f)
      var table;
      var geocoder;
      var click_count = 0;
      var using_current = false

      function stringifyDate(d) {
        var year = d.getFullYear();
        var month = d.getMonth() + 1;
        var day = d.getDate();
        var hour = d.getHours();
        var minute = d.getMinutes();
        var second = d.getSeconds();

        if (month < 10)
          month = '0' + month;
        if (day < 10)
          day = '0' + day;
        //if (hour < 10)
    //      hour = '0' + hour;
        return year + '-' + month + '-' + day;
      }

      //min_string = stringifyDate(c);
      //max_string = stringifyDate(f);

   //   $('#datepicker').attr('minDate', min_string);
     // $('#datepicker').attr('maxDate', max_string);

      if ($('#checkbox').is(':checked')) {
        $('#date_input').hide();
      }
        
  
        
        
      function disappear(){
        $('#date_input').toggle();
      }

	document.getElementById("clear_all").onclick = function clearAll() {
		console.log("clearing")
		removeMarkers()
		directionsDisplay.setMap(null);

	}

      
	    function validateForm() {

		    start = document.getElementById("start_address").value;
		    end = document.getElementById("end_address").value;

        if (start == "" || end == "") {
			    console.log("invalid")
			    $('#invalid > p').text("Oops, please complete the form and try again");
			    return false;
        }

		    else {
			    $('#invalid > p').text("");
			    return true;
		    }		
	    }
      
      var icon_code;
      switch(weather_description) {
        case 'broken clouds':
          icon_code = '04';
          break;
        case 'clear sky':
          icon_code = '01';
          break;
        case 'few clouds':
          icon_code = '02';
          break;
        case 'scattered clouds': 
          icon_code = '03';
          break;
        case 'shower rain':
          icon_code = '09';
          break;
        case 'rain': 
          icon_code = '10';
          break;
        case 'thunderstorm': 
          icon_code = '11';
          break;
        case 'snow':
          icon_code = '13';
          break;
        case 'mist':
          icon_code = '50';
          break;
        default: 
          icon_code = '04';
      }
      
      if (7 < new Date().getHours() < 21) {
        icon_code += 'd';
      } else {
        icon_code += 'n';
      }
      $("#icon").attr("src","http://openweathermap.org/img/w/" + icon_code + ".png");

      function initMap(){
	      directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers:true});
        directionsService = new google.maps.DirectionsService();
        geocoder = new google.maps.Geocoder;
        map = new google.maps.Map(document.getElementById('map'), {
        	zoom: 12,
          center: {lat: 53.3498, lng: -6.2603}
            
        });
        var trafficLayer = new google.maps.TrafficLayer();
	      trafficLayer.setMap(map);    

	      //autocomplete section on init
        var input_start = document.getElementById('start_address');
	      var input_end = document.getElementById('end_address');

	      var store = []

	      var cityBounds = new google.maps.LatLngBounds(
		      new google.maps.LatLng(52.840362, -7.228772),
		      new google.maps.LatLng(54.017627, -6.164425)
		    );

        var options = {
		      bounds: cityBounds,
          types: ['geocode'],
          componentRestrictions : {country: 'ie'}
        };

	      var fields = [
		      'address_components',
		      'geometry',
		      'icon',
		      'name'
	      ];
        
        autocomplete_start = new google.maps.places.Autocomplete(input_start, options);
	      autocomplete_start.setFields(fields);
        autocomplete_end = new google.maps.places.Autocomplete(input_end, options);
	      autocomplete_end.setFields(fields);

        store.push(autocomplete_start);
        store.push(autocomplete_end);

	      for (var i = 0; i< store.length; i++) {
		      store[i].addListener('place_changed', function() {
			      if (store[i]){
			        var place = store[i].getPlace();
			        if (!place.geometry) {
				        window.alert("No details available for input: '" + place.name + "'");
				        return;
			        }
			      }
			    });
	      }

	google.maps.event.addListener(map, 'click', async function(event) {

        newLat=event.latLng.lat();
        newLng=event.latLng.lng();
        
        
        if (click_count == 0 && !using_current) {
            removeMarkers()
            directionsDisplay.setMap(null);
	    $('#start_address').val("")
            $('#end_address').val("")
            placeMarker(event.latLng);
            var address =  await geocodeLatLng(event.latLng)
            $('#start_address').val(address)
            click_count++
        }
        else if (click_count == 1 && !using_current) {
            placeMarker(event.latLng);
            click_count = 0
	    var address = await geocodeLatLng(event.latLng)
            $('#end_address').val(address)
        }

	else if (click_count == 0 && using_current) {
            console.log(using_current);
	    placeMarker(event.latLng);
	    click_count = 0
            using_current = false;
	    var address = await geocodeLatLng(event.latLng)
            $('#end_address').val(address)	

	}
        
	console.log(click_count);

});

function removeMarkers(){
          for (var i = 0; i < markers.length; i++){
            markers[i].setMap(null);
          };
        };


				

	      return;
      };

      function placeMarker(latlng){
        var marker1 = new google.maps.Marker({
          position: latlng,
          map: map 
        })
        markers.push(marker1)
      }

      function geocodeLatLng(latlng) {
        return new Promise(function(resolve, reject) {
          geocoder.geocode({'location':latlng}, function(results, status) {
            if (status === "OK") {
              var address = (results[0].formatted_address);
              resolve(address);
            }
          })
        })
      }

      function getDirections() {

       return new Promise(function(resolve, reject) {	
          var result = []
          var walk_time	
          var start = document.getElementById("start_address").value;
          var end = document.getElementById("end_address").value;
        
          var request = {
            origin: start,
            destination: end,
            travelMode: 'TRANSIT',
            transitOptions: {
              modes: ['BUS'],
              routingPreference : 'FEWER_TRANSFERS'
            },
          }
    
          directionsService.route(request, function(result, status){
            var context = {}
            var step_no = 1
            var no_bus = 0
            var walk_time = 0;
            table = "<table id = text_directions><tr><th>Step</th><th>Estimate Time</th></tr>"
            if (status == "OK") {
              console.log(result);
              directions = result
              steps = result.routes[0].legs[0].steps
              for (var i = 0; i<steps.length; i++) {
                if (steps[i].travel_mode == "TRANSIT") {
                  route = []
                  table+="<tr><td>"+steps[i].transit.line.short_name+" "+steps[i].instructions+" for "+steps[i].transit.num_stops+" stops"+"<td id=step_"+no_bus+"></td></tr>"
		              no_bus += 1
                  var bus_no = steps[i].transit.line.short_name 
                  var lat1 = steps[i].transit.departure_stop.location.lat()
                  var lat2 = steps[i].transit.arrival_stop.location.lat()

                  var lng1 = steps[i].transit.departure_stop.location.lng()
                  var lng2 = steps[i].transit.arrival_stop.location.lng()
                  
                  route.push(lat1);
                  route.push(lng1)
                  route.push(lat2)
                  route.push(lng2)
                  route.push(bus_no)
                  context[step_no] = route
                  step_no++
                } else {
                  walk_time += steps[i].duration.value;
                  table += "<tr><td>"+steps[i].instructions+"</td><td>"+steps[i].duration.text+"</td></tr>"
                }
              }
              table += '</table>'
              context["walk_time"] = walk_time
              resolve(context);	
            }
          });
        });
      }	

      var stops = {};
      {% for stop in stops %}
        var mystop = {};
        //mystop["lat"] = "{{stop.lat}}";
        //mystop["long"] = "{{stop.long}}";
        //mystop["stop_name"] = "{{stop.stop_name}}";
        mystop["stop_address"] = "{{stop.stop_address}}";
        //mystop["zone"] = "{{stop.zone}}";
        stops['{{stop.stop_id}}'] = mystop;
      {% endfor %}

      var routes = {};
      {% for rn in route_numbers %}
        routes["{{rn}}" + ' '] = {'I':[],'O':[]};
      {% endfor %}

      {% for stop in routes %}
        var mystop = {}
        mystop['stop_id'] = "{{stop.stop_id}}";
        mystop['sequence'] = "{{stop.sequence}}";
        //mystop['distance'] = "{{stop.distance}}";
        routes['{{stop.route_number}}' + ' ']['{{stop.route_direction}}'].push(mystop)
      {% endfor %} 


var pos;

	if (navigator.geolocation) {

                        navigator.geolocation.getCurrentPosition(function(position) {

                                pos = {

                                        lat: position.coords.latitude,
                                        lng: position.coords.longitude,
                                        
                                        }

                });

	}

      $(document).ready(function(){



	 document.getElementById("clear_all").onclick = function clearAll() {
                $('#start_address').val("")
		$('#end_address').val("")
		$('#results').html("")
		$('#text_results').html("")
		$('#price').html("")
		//$('#leap_stores').prop('checked', false);
		$('#geolocation').prop('checked', false);
                removeMarkers()
                using_current = false;
                directionsDisplay.setMap(null);

        }



        /*$.when(
          $.get('/get_routes/', function(data){
            routes=JSON.parse(data);
          }),
          $.get('/get_stops', function(data){
            stops=data;
          })
        ).done( function(){
          stops=JSON.parse(stops);
          routes=JSON.parse(routes);
        });*/

        /*$.ajax({
          url: 'get_routes/',
          success: function (data) {
              routes=data;
          },
          async: false
        });

        $.ajax({
          url: 'get_stops/',
          success: function (data) {
              stops=data;
          },
          async: false
        });

        route=JSON.parse(routes)
        stops=JSON.parse(stops)*/
        $('#routes').html('<option>Select Route</option>');

        Object.keys(routes).forEach(function(element){
          $('#routes').append('<option>' + element.substr(0, element.length-1) + '</option>');
          $('#routes').prop('disabled', false)
        })        
          
        $("#routes").change(function(){
          var route = $("#routes option:selected").text();
          if (route == "Select Route") {
            return;
          }
          $('#start').html('<option>Loading...</option>');
          $('#end').html('<option>Select Start Stop</option>');
          $('#start').prop('disabled', true);
          var options = "";
          routes[route + ' ']['I'].forEach(function(element){
            options += '<option value="Incoming">' + element.stop_id + ", " + stops[element.stop_id]['stop_address'] + " (Incoming)</option>";
          });
          routes[route + ' ']['O'].forEach(function(element){
            options += '<option value="Outgoing">' + element.stop_id + ", " + stops[element.stop_id]['stop_address'] + " (Outgoing)</option>";
          });
          $('#start').html('<option>Select Start Stop</option>');
          $('#start').append(options);
          $('#start').prop('disabled', false);
        }); 
          
        $("#start").change(function(){
          var route = $("#routes option:selected").text();
          var start = $("#start option:selected").text().split(',')[0];
          if (start == "Select Start Stop"){
            return;
          }
          var direction = $('#start').val();
          var d = direction.substr(0,1);
          $('#end').html('<option>Loading...</option>');
          $('#end').prop('disabled', true);
          var options = "";
          var found = false;

          routes[route + ' '][d].forEach(function(element){
            if (found){
              options += '<option>' + element.stop_id + ", " + stops[element.stop_id]['stop_address'] + " (" + direction + ")</option>";
            };
            if (start == element.stop_id){
              found = true;
            };
          });

          $('#end').html('<option>Select End Stop</option>');
          $('#end').append(options);
          $('#end').prop('disabled', false);  
        });
          
        $('#post-form').on('submit', function(event){
          event.preventDefault();
          console.log("form submitted!");
          $('#results > p').text('waiting...');
          getPredictions()
        });

        function getInputDate(){
          if ($('#checkbox').is(':checked')){
            console.log('actual datetime')
            return [c, true];
          } else {
            console.log('input datetime')
            var time = document.getElementById('timepicker').value;
            var timeSplit = time.split(':');
            var hr = parseInt(timeSplit[0]);
            var min = parseInt(timeSplit[1]);                      

            var date = $('#datepicker').val(); 
            var dateSplit = date.split('/');
            var day=parseInt(dateSplit[1]);
            var month = parseInt(dateSplit[0])-1;
            var year = parseInt(dateSplit[2]);

            d=new Date(year, month, day, hr, min);
            return [d, false];
          }
        }

        function getLeap(price){
          switch (price) {
            case '€2.10':
              return ' / €1.50 (Leap)';
            case '€2.85':
              return ' / €2.15 (Leap)';
            case '€3.30':
              return ' / €2.60 (Leap)';
            case '€3.65':
              return ' / €2.90 (Leap)';
            default:
              return '';
          }
        }

	function geoLocation() {

		if (navigator.geolocation) {

                        navigator.geolocation.getCurrentPosition(function(position) {

                                var pos = {

                                        lat: position.coords.latitude,
                                        lng: position.coords.longitude,
                                        
                                        }

                });
	}

	}

         document.getElementById("geolocation").onclick = function getLocation(){

			removeMarkers()
			directionsDisplay.setMap(null);
			geoLocation()

                                console.log(pos)

                                map.setCenter(pos);

                                current_location = new google.maps.Marker({
                                        position: {lat: pos.lat, lng: pos.lng},
                                        map: map,
                                        title: "Current Location"
                
                                });

                                markers.push(current_location);

                                var geocoder = new google.maps.Geocoder;
                                
                                geocoder.geocode({'location' : pos}, function(result, status) {

                                        if (status == "OK") {
                                                console.log(result[0].formatted_address);
                                                $("#start_address").val(result[0].formatted_address)
						using_current = true;
                                        }

                                });

                        

		

		}

	

	document.getElementById("leap_stores").onclick = function() {


		//cb = this.checked;

		//if (cb){
			geoLocation()
	                map.setCenter(pos);
			removeMarkers()
			directionsDisplay.setMap(null);

			output = []
          		output.push(pos)          
          		console.log(output)
          		context = JSON.stringify(output)   
			
			$.get("/leap_stores/", {context}, function(data) {

				for (key in data) {
					
					marker = new google.maps.Marker({
						position: {lat: Number(data[key]["lat"]), lng: Number(data[key]["lng"])},
						map: map,
						title: key,	

						});

					markers.push(marker);

				}

			});

		}

		//else {

			//removeMarkers()

		//}

	//}
	
        function getPredictions(){  
          route = $("#routes option:selected").text();
          start_stop = $('#start option:selected').text().split(',')[0];
          end_stop = $('#end option:selected').text().split(',')[0];
          if (route == 'Select Route' || start_stop == 'Select Start Stop' || end_stop == 'Select End Stop' || end_stop == 'Select Start Stop') {
            $('#results > p').html("Please fill out all sections");
            return
          }
          date = getInputDate()[0];
          year = date.getFullYear();
          month = date.getMonth() + 1;
          day = date.getDate();
          hour = date.getHours();
          minute = date.getMinutes();
          now = getInputDate()[1];
          console.log("Route =", route, "Start Stop =", start_stop, "End Stop =", end_stop, "Day =", day, "Hour =", hour, "Minute =", minute, "Now =", now);

          $.get('/predict_request/', {route: route, start_stop: start_stop, 
            end_stop: end_stop, year: year, month: month, day: day, 
            hour: hour, minute: minute, now: now}, function(data){

              var myDiv = document.getElementById('collapseExample1')
              myDiv.scrollTop = myDiv.scrollHeight
              
              if (typeof data == 'string') {
                console.log('error')
                $('#results > p').html(data);
              } else {
                console.log('not error')
                var leap = getLeap(data['price']);
                var results = "";
                results = 'Wait time: ' + data['wait'] + '<br>';
                results += 'Travel time: ' + data['prediction'] + '<br>Price: ' + data['price'] +  leap;
                console.log(data['prediction'], data['price'])
                $('#results > p').html(results);
              }
          });
	        $.get('/popStops/', {route: route, start_stop: start_stop, end_stop: end_stop}, function(data){
            popStops(data['stops']);
            console.log(data['stops']);
            var s = data['stops'][0][0]
            console.log('s:',s)
            var start = {lat: Number(s['lat']), lng: Number(s['lon'])}
            var e = data['stops'][0][1]
            console.log('e:',e)
            var end = {lat: Number(e['lat']), lng: Number(e['lon'])}
            var request = {
              origin: start,
              destination: end,
              travelMode: 'TRANSIT',
              transitOptions: {
                modes: ['BUS'],
                routingPreference: 'FEWER_TRANSFERS'
              },
            }
            directionsService.route(request, function(result, status){
              if (status == 'OK'){
                directions = result;
                console.log('status:', status)
              }
              drawRoute(data['stops']);
            })
          });
        };

		    $('#post-form1').on('submit', function(event){
          event.preventDefault()
          valid = validateForm()
			    if (valid) {
            $('#text_results').text('waiting...');
            $('#price').text("");
			      getPredictionsAddress();
		      }
		    });

        function drawRoute(data){
          directionsDisplay.setMap(map);
          directionsDisplay.setDirections(directions);
        }          

        function popStops(context){
          console.log(context)
          removeMarkers();
          markers = []
          for (var i in context) {
              console.log(i); 
              var marker = new google.maps.Marker({
                position: {lat: Number(context[i][0]["lat"]), lng: Number(context[i][0]["lon"])},
                map: map,
                title: context[i][0]["stop"],
                //icon :  "/static/images/bus-station.svg"
                  
              });
                
                
                
               
              markers.push(marker)

              var length = Object.keys(context[i]).length
	      
	      var marker = new google.maps.Marker({
                position: {lat: Number(context[i][length-1]["lat"]), lng: Number(context[i][length-1]["lon"])},
                map: map,
                title: context[i][length-1]["stop"],
                //icon :  "/static/images/bus-station.svg"
              });
              markers.push(marker);
            

            if ($('#checkbox').is(':checked') && i == 0){
              var content = "<table> <tr> <th> Route </th> <th style = 'padding : 5px'> ETA(mins) </th> </tr> " 
              if (context[i][0]['rtpi']['results'].length == 0) {
                content = content + '<tr><td>No RTPI Available</td></tr>';
              } else {
                for (var j = 0; j < 10 && j < context[i][0]['rtpi']['results'].length; j++){
                  content = content + "<tr> <td>" + context[i][0]["rtpi"]["results"][j]["route"] + "</td> <td>" + context[i][0]["rtpi"]["results"][j]["duetime"] + "</td> </tr>"
                };
              }
              
              var infowindow = new google.maps.InfoWindow({
                content: content
              });
            
              infowindow.open(map, markers[0]);
              google.maps.event.addListener(markers[0], 'click', function() {
                console.log("hello");
                infowindow.open(map, markers[0]);
              });
            }

          };
        };

        async function getPredictionsAddress() {
		
          var context = await getDirections();
          output = []
          output.push(context)		
          console.log(output)
          context = JSON.stringify(output)		
          
          date = getInputDate()[0];
          year = date.getFullYear();
          month = date.getMonth() + 1;
          day = date.getDate();
          hour = date.getHours();
      
          $.get('/predict_address/', {context: context, year: year, month: month, day: day, hour: hour}, function(data) {
            var x = [0,1,2,3,4]
            for (y in x) {
		          $("#step_"+x).html("Getting Prediction")
		        }
            if (data["error"] == "0") {
              popStops(data["stops"])
              drawRoute(data["stops"])
              $('#text_results').html(table);
              var myDiv = document.getElementById('collapseExample')
              myDiv.scrollTop = myDiv.scrollHeight
              var count = 0
              var price = 0
              for (i in data["prediction"]) {
                console.log(i)		
                var step = "step_"+count
                $("#"+step).html(data["prediction"][i]);
                count += 1
              }

              for (i in data["price"]) {		
                var price_split = data["price"][i]
                price_split = price_split.split(".")
                var euro = Number(price_split[0])*100
                var cent = Number(price_split[1])
                total = euro + cent
                price += total
              }
              
              euro = Math.floor(price/100);
              cent = price%100;
              if (cent < 10)
                cent = "0" + cent;

              price = "€" + euro + "." + cent
              leap = getLeap(price)
              $("#price").html('Journey Cost: ' + price + leap)
              
            } else if (data["error"] == "0") {
              $('#results > p').html("Oops, something went wrong. Enter a different route and please try again.");
            } else if (data["error"] == "tbi") {
              $('#results > p').html("Error: One or more routes not yet implemented.");
            } else if (data["error"] == "uncovered") {
              $('#results > p').html("Error: One or more routes not covered by our data.");
            } else if (data["error"] == "nis") {
              $('#results > p').html("Error: One or more routes not in service.");
            } else if (data["error"] == "unsupported") {
              $('#results > p').html("Error: One or more routes not supported by our data.");
            } else if (data["error"] == "nim") {
              $('#results > p').html("Error: One or more routes not implemented in our application.");
            }
          });
        };

        function removeMarkers(){
          for (var i = 0; i < markers.length; i++){
            markers[i].setMap(null);
          };
        };

        var modal = document.querySelector(".info_modal");
        modal.style.display = "none";

	document.querySelector("#info_icon").onclick = function(){
	        console.log(modal)
		toggleModal()
              
	}

	document.querySelector("#close_modal").onclick = function() {

		toggleModal()	

	}

	window.onclick = function(event) {
		
		if (event.target == modal) {

			toggleModal()

		}

	}

	function toggleModal() {
		console.log("toggle")
		if (modal.style.display == 'none'){
			modal.style.display = "block";
		}
		else {
			modal.style.display = "none";
		}
	}

	});
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADAq7_ArNs1g_fzNE-tLB0scnM5UtXXSM&callback=initMap&libraries=places" type = 'text/javascript'></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>   
    
  </body>
</html>
